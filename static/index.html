<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>åƒé—®å¯å·â€”â€”å¤§æ¨¡å‹é©±åŠ¨çš„æ™ºèƒ½å‘½é¢˜ç³»ç»Ÿ</title>
<style>
:root {
  --primary-color: #2c3e50;
  --accent-color: #3498db;
  --success-color: #27ae60;
  --text-color: #34495e;
  --error-color: #e74c3c;
}
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  padding: 2rem 1rem;
  background: #f5f6fa;
  color: var(--text-color);
  max-width: 800px;
  margin: 0 auto;
  transition: all 0.3s ease;
}
.header {
  text-align: center;
  margin-bottom: 2rem;
}
.form-container {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
}
.form-container:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}
.input-group {
  margin-bottom: 1.5rem;
}
.input-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: var(--primary-color);
}
.input-group label.required:before {
  content: "*";
  color: var(--error-color);
  margin-right: 4px;
}
input, textarea, select {
  width: 100%;
  padding: 0.8rem;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s;
}
input:focus, textarea:focus, select:focus {
  border-color: var(--accent-color);
  outline: none;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}
.question-type-group {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-bottom: 1rem;
}
.question-type-group select,
.question-type-group .count-input,
.question-type-group .custom-type-input {
  flex: 1;
  max-width: 25%;
}
.custom-type-input {
  display: none;
}
.count-input {
  padding: 0.5rem;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
}
.button {
  background: var(--accent-color);
  color: white;
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
  letter-spacing: 0.5px;
}
.button:hover {
  opacity: 0.9;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.add-button {
  background: hsl(209, 100%, 68%);
  width: 20%;
}
.download-link {
  display: inline-block;
  margin-top: 1rem;
  padding: 1rem 2rem;
  background: var(--success-color);
  color: white;
  text-decoration: none;
  border-radius: 8px;
  font-weight: 600;
  transition: all 0.3s;
}
.download-link:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
}
.error-message {
  color: var(--error-color);
  text-align: center;
  margin-top: 1rem;
  font-weight: 500;
}
.grade-detail-group {
  margin-top: 0.5rem;
  display: none;
}
.delete-button {
  background: #e74c3c !important;
  padding: 0.5rem 1rem !important;
  flex: 0 0 auto;
}
.delete-button:hover {
  background: #c0392b !important;
}
.progress-container {
  margin-top: 2rem;
  text-align: center;
}
.progress-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}
.progress-label {
  font-weight: 500;
  color: var(--primary-color);
}
.progress-percentage {
  font-weight: 600;
  color: var(--accent-color);
}
.progress-bar-wrapper {
  height: 16px;
  background: #e0e0e0;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}
.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #3498db, #2ecc71);
  border-radius: 10px;
  width: 0%;
  transition: width 0.5s ease-out;
}
.status-message {
  margin-top: 1rem;
  text-align: center;
  font-weight: 500;
}
.status-message.generating {
  color: var(--accent-color);
}
.status-message.success {
  color: var(--success-color);
}
.status-message.error {
  color: var(--error-color);
}
@keyframes pulse {
  0% { opacity: 0.7; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}
.generating-animation {
  animation: pulse 1.5s infinite;
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-3px); }
}
.shake {
  animation: shake 0.5s;
}
</style>
</head>
<body>
<header class="header">
  <h1>ğŸ“š åƒé—®å¯å·â€”â€”å¤§æ¨¡å‹é©±åŠ¨çš„æ™ºèƒ½å‘½é¢˜ç³»ç»Ÿ</h1>
  <p>æ™ºèƒ½åˆ›å»ºä¸ªæ€§åŒ–æ•™å­¦è¯•å·</p>
</header>

<main>
  <div class="form-container">
    <div class="input-group">
      <label for="subject" class="required">å­¦ç§‘åç§°</label>
      <select id="subject">
        <option>è¯­æ–‡</option>
        <option selected>æ•°å­¦</option>
        <option>è‹±è¯­</option>
        <option>ç‰©ç†</option>
        <option>åŒ–å­¦</option>
        <option>ç”Ÿç‰©</option>
        <option>å†å²</option>
        <option>åœ°ç†</option>
        <option>æ”¿æ²»</option>
        <option value="other">å…¶ä»–</option>
      </select>
      <input type="text" class="dynamic-input" id="subject-other" placeholder="è¯·è¾“å…¥å…¶ä»–å­¦ç§‘åç§°">
    </div>

    <div class="input-group">
      <label for="grade" class="required">é€‚ç”¨å¹´çº§</label>
      <select id="grade">
        <option>å°å­¦</option>
        <option selected>åˆä¸­</option>
        <option>é«˜ä¸­</option>
        <option>å¤§å­¦</option>
        <option value="other">å…¶ä»–</option>
      </select>
      <input type="text" class="dynamic-input" id="grade-other" placeholder="è¯·è¾“å…¥å…¶ä»–å¹´çº§">
      
      <div id="grade-detail-primary" class="grade-detail-group">
        <select id="primary-grade">
          <option>ä¸€å¹´çº§</option>
          <option>äºŒå¹´çº§</option>
          <option>ä¸‰å¹´çº§</option>
          <option>å››å¹´çº§</option>
          <option>äº”å¹´çº§</option>
          <option>å…­å¹´çº§</option>
        </select>
      </div>
      
      <div id="grade-detail-middle" class="grade-detail-group">
        <select id="middle-grade">
          <option>ä¸ƒå¹´çº§</option>
          <option>å…«å¹´çº§</option>
          <option>ä¹å¹´çº§</option>
        </select>
      </div>
      
      <div id="grade-detail-high" class="grade-detail-group">
        <select id="high-grade">
          <option>é«˜ä¸€</option>
          <option>é«˜äºŒ</option>
          <option>é«˜ä¸‰</option>
        </select>
      </div>
    </div>

    <div class="input-group">
      <label>é¢˜ç›®è®¾ç½® <span style="color: gray;">ï¼ˆå¯é€‰ï¼‰</span></label>
      <div id="question-type-container"></div>
      <button type="button" class="button add-button" onclick="addQuestionType()">âœš æ·»åŠ é¢˜å‹</button>
    </div>

    <div class="input-group">
      <label for="prompt">ç”Ÿæˆè¦æ±‚ <span style="color: gray;">ï¼ˆå¯é€‰ï¼‰</span></label>
      <textarea id="prompt" placeholder="ä¾‹å¦‚ï¼šé¢˜ç›®éš¾åº¦é€‚ä¸­ï¼ŒçŸ¥è¯†ç‚¹æ¶µç›–å…¨é¢ï¼ŒåŒ…å«å‡ ä½•ä¸ä»£æ•°é¢˜ç›®"></textarea>
    </div>

    <div class="input-group" style="text-align: center;">
      <button class="button" onclick="generate()" id="generateBtn">ç«‹å³ç”Ÿæˆè¯•å·</button>
    </div>
  </div>

  <div id="download" style="text-align: center; margin-top: 1.5rem;"></div>
  <div id="error" class="error-message"></div>
  
  <div id="progress-container" class="progress-container" style="display: none;">
    <div class="progress-header">
      <span class="progress-label">ç”Ÿæˆè¿›åº¦</span>
      <span id="progress-percentage" class="progress-percentage">0%</span>
    </div>
    <div class="progress-bar-wrapper">
      <div id="progress-bar" class="progress-bar"></div>
    </div>
    <div id="status-message" class="status-message generating">è¯•å·ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...</div>
  </div>
</main>

<script>
// åˆå§‹åŒ–å‡½æ•°
function setupDynamicInputs() {
  const config = [
    { select: 'subject', input: 'subject-other' },
    { select: 'grade', input: 'grade-other' }
  ];

  config.forEach(({ select, input }) => {
    const selectEl = document.getElementById(select);
    const inputEl = document.getElementById(input);
    const toggle = () => {
      inputEl.style.display = selectEl.value === 'other' ? 'block' : 'none';
      if (selectEl.value !== 'other') inputEl.value = '';
    };
    selectEl.addEventListener('change', toggle);
    toggle();
  });

  // å¹´çº§ç»†åˆ†é€‰æ‹©åŠŸèƒ½
  const gradeSelect = document.getElementById('grade');
  const primaryGrade = document.getElementById('grade-detail-primary');
  const middleGrade = document.getElementById('grade-detail-middle');
  const highGrade = document.getElementById('grade-detail-high');
  const otherGrade = document.getElementById('grade-other');

  function updateGradeDetail() {
    primaryGrade.style.display = 'none';
    middleGrade.style.display = 'none';
    highGrade.style.display = 'none';
    
    switch(gradeSelect.value) {
      case 'å°å­¦':
        primaryGrade.style.display = 'block';
        break;
      case 'åˆä¸­':
        middleGrade.style.display = 'block';
        break;
      case 'é«˜ä¸­':
        highGrade.style.display = 'block';
        break;
    }
  }

  gradeSelect.addEventListener('change', updateGradeDetail);
  updateGradeDetail();
}

const ALL_TYPES = ['é€‰æ‹©é¢˜', 'åˆ¤æ–­é¢˜', 'å¡«ç©ºé¢˜', 'è®¡ç®—é¢˜', 'ç®€ç­”é¢˜', 'ç»¼åˆé¢˜'];
const container = document.getElementById('question-type-container');

function addQuestionType() {
  const wrapper = document.createElement('div');
  wrapper.className = 'question-type-group';

  const select = document.createElement('select');
  const optionOther = document.createElement('option');
  optionOther.value = 'å…¶ä»–';
  optionOther.textContent = 'å…¶ä»–';

  const deleteBtn = document.createElement('button');
  deleteBtn.className = 'button delete-button';
  deleteBtn.innerHTML = 'âœ˜ åˆ é™¤';
  deleteBtn.onclick = () => wrapper.remove();

  // è·å–å½“å‰æ‰€æœ‰å·²é€‰æ‹©çš„é¢˜å‹ï¼ˆä¸åŒ…æ‹¬"å…¶ä»–"ï¼‰
  const selectedTypes = Array.from(container.querySelectorAll('select'))
    .map(s => s.value)
    .filter(val => val !== 'å…¶ä»–');

  // æ·»åŠ æœªè¢«é€‰è¿‡çš„é¢˜å‹
  ALL_TYPES.forEach(type => {
    if (!selectedTypes.includes(type)) {
      const option = document.createElement('option');
      option.value = type;
      option.textContent = type;
      select.appendChild(option);
    }
  });

  select.appendChild(optionOther);

  const customInput = document.createElement('input');
  customInput.type = 'text';
  customInput.className = 'custom-type-input';
  customInput.placeholder = 'è¯·è¾“å…¥è‡ªå®šä¹‰é¢˜å‹åç§°';

  const countInput = document.createElement('input');
  countInput.type = 'number';
  countInput.className = 'count-input';
  countInput.min = 0;
  countInput.max = 50;
  countInput.value = 0;
  countInput.placeholder = 'æ•°é‡';

  select.addEventListener('change', () => {
    customInput.style.display = select.value === 'å…¶ä»–' ? 'block' : 'none';
    if (select.value !== 'å…¶ä»–') customInput.value = '';
  });

  wrapper.appendChild(select);
  wrapper.appendChild(customInput);
  wrapper.appendChild(countInput);
  wrapper.appendChild(deleteBtn); 
  container.appendChild(wrapper);

  // åˆå§‹çŠ¶æ€æ£€æŸ¥
  if (select.value === 'å…¶ä»–') {
    customInput.style.display = 'block';
  }
}

function getDynamicValue(selectId) {
  const select = document.getElementById(selectId);
  const input = document.getElementById(`${selectId}-other`);
  return select.value === 'other' ? input.value.trim() : select.value;
}

function getGradeDetail() {
  const gradeSelect = document.getElementById('grade');
  switch(gradeSelect.value) {
    case 'å°å­¦':
      return document.getElementById('primary-grade').value;
    case 'åˆä¸­':
      return document.getElementById('middle-grade').value;
    case 'é«˜ä¸­':
      return document.getElementById('high-grade').value;
    case 'å¤§å­¦':
      return 'å¤§å­¦';
    case 'other':
      return document.getElementById('grade-other').value.trim();
    default:
      return '';
  }
}

function collectQuestionCounts() {
  const entries = container.querySelectorAll('.question-type-group');
  const result = {};

  for (const entry of entries) {
    const typeSelect = entry.querySelector('select');
    const customInput = entry.querySelector('.custom-type-input');
    const countInput = entry.querySelector('.count-input');

    const type = typeSelect.value === 'å…¶ä»–' 
      ? customInput.value.trim()
      : typeSelect.value;

    const count = parseInt(countInput.value) || 0;

    if (!type && count > 0) throw new Error('è¯·è¾“å…¥è‡ªå®šä¹‰é¢˜å‹åç§°');
    if (type && count > 0) result[type] = count;
  }

  return result;
}

// æ›´æ–°è¿›åº¦æ¡å‡½æ•°
function updateProgressBar(percentage, message = '') {
  const progressBar = document.getElementById('progress-bar');
  const progressPercentage = document.getElementById('progress-percentage');
  const statusMessage = document.getElementById('status-message');
  
  progressBar.style.width = `${percentage}%`;
  progressPercentage.textContent = `${Math.round(percentage)}%`;
  
  if (message) {
    statusMessage.textContent = message;
    
    // æ ¹æ®æ¶ˆæ¯ç±»å‹æ›´æ–°æ ·å¼
    if (message.includes('æˆåŠŸ')) {
      statusMessage.className = 'status-message success';
    } else if (message.includes('é”™è¯¯')) {
      statusMessage.className = 'status-message error';
    } else {
      statusMessage.className = 'status-message generating';
    }
  }
}

async function generate() {
  const btn = document.getElementById('generateBtn');
  btn.disabled = true;
  document.getElementById('error').textContent = '';
  document.getElementById('download').innerHTML = '';

  const progressContainer = document.getElementById('progress-container');
  progressContainer.style.display = 'block';
  updateProgressBar(0, 'è¯•å·ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...');

  try {
    const subject = getDynamicValue('subject');
    const grade = getGradeDetail();
    const prompt = document.getElementById('prompt').value.trim();
    const questionCounts = collectQuestionCounts();

    if (!subject) throw new Error('è¯·å¡«å†™å­¦ç§‘åç§°');
    if (!grade) throw new Error('è¯·å¡«å†™é€‚ç”¨å¹´çº§');

    // ç»„è£…é¢˜å‹æ•°ç»„
    const question_types = Object.entries(questionCounts).map(([type, count]) => ({
      type, count
    }));

    // è¿›åº¦æ¡é˜¶æ®µ1
    updateProgressBar(10, 'æ­£åœ¨æäº¤ç”Ÿæˆè¯·æ±‚...');

    // å‘é€è¯·æ±‚åˆ°åç«¯
    const res = await fetch('/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        subject,
        grade,
        question_types,
        prompt
      })
    });

    if (!res.ok) {
      throw new Error('åç«¯æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
    }
    const data = await res.json();

    // è¿›åº¦æ¡é˜¶æ®µ2
    updateProgressBar(80, 'æ­£åœ¨ç”ŸæˆWordæ–‡æ¡£...');

    // æ˜¾ç¤ºä¸‹è½½é“¾æ¥
    const link = document.createElement('a');
    link.className = 'download-link';
    link.textContent = 'â¬‡ï¸ ä¸‹è½½è¯•å·æ–‡ä»¶ (Word)';
    link.href = `/download?path=${encodeURIComponent(data.file)}`;
    link.download = '';
    document.getElementById('download').appendChild(link);

    updateProgressBar(100, 'è¯•å·ç”ŸæˆæˆåŠŸï¼');
  } catch (err) {
    updateProgressBar(100, 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
    document.getElementById('progress-bar').style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
    document.getElementById('error').textContent = 'é”™è¯¯ï¼š' + err.message;
    document.querySelector('.form-container').classList.add('shake');
    setTimeout(() => {
      document.querySelector('.form-container').classList.remove('shake');
    }, 500);
    setTimeout(() => {
      progressContainer.style.display = 'none';
    }, 3000);
  } finally {
    setTimeout(() => {
      updateProgressBar(0);
      document.getElementById('progress-bar').style.background = 'linear-gradient(90deg, #3498db, #2ecc71)';
    }, 3000);
    btn.disabled = false;
  }
}

window.addEventListener('DOMContentLoaded', () => {
  setupDynamicInputs();
  addQuestionType();
});
</script>
</body>
</html>